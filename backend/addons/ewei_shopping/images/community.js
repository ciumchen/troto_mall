!function(t,s,i){function n(t){this.list=t.list,this.nav=t.nav,this.con=t.con,this.on=t.on,this.listImg=t.listImg,this.imgSrc=t.imgSrc,this.h=parseInt(s.documentElement.clientHeight||s.body.clientHeight),this.imgs=this.listImg.getElementsByTagName("img"),this.len=this.imgs.length,this.curIndex=0,this.sel=t.sel,this.total=t.total,this.ship=t.ship,this.btn=t.btn,this.dataArr={},this.dataArr.goods=[],this.load=t.load,this.url=t.url,this.topArr=[],this.init()}n.prototype={constructor:n,addCart:function(){function t(){var t,i,n,o,a=parseInt(0);s.dataArr={},s.dataArr.goods=[],s.con.find("li").each(function(){var e=$(this);e.hasClass(s.sel)&&(t=e.attr("data-goodsid"),i=parseInt(e.attr("data-stock")),n=parseFloat(e.attr("data-price")).toFixed(2),o=parseInt(e.attr("data-num")),s.dataArr.goods.push({goodsid:t,stock:i,price:n,num:o}),a=parseFloat(a+n*o))}),s.dataArr.total=parseFloat(a).toFixed(2),s.total.find("span").text("￥"+s.dataArr.total)}var s=this;num=0,stock=0,this.list.find("li").on("click",function(){var i=$(this);i.addClass(s.sel).addClass(s.on),setTimeout(function(){i.removeClass(s.on)},200),num=parseInt(i.attr("data-num")),stock=parseInt(i.attr("data-stock")),stock>num?num++:(num=stock,alert("抱歉，只剩下"+stock+"件商品了！")),i.attr("data-num",num).find("i").text(num),num>0?(i.find("i").show(),i.find("h3").hide(),i.find("span").css("display","block")):(i.find("i").hide(),i.find("h3").show(),i.removeClass(s.sel).find("span").hide()),t()}),this.list.find("span").on("click",function(i){i.stopPropagation();var n=$(this),o=n.parents("li");o.addClass(s.on),setTimeout(function(){o.removeClass(s.on)},200),num=parseInt(o.attr("data-num")),num--,num>0?o.attr("data-num",num).find("i").text(num):(n.hide(),o.removeClass(s.sel).find("i").hide(),o.find("h3").show(),o.attr("data-num",0).find("i").text(num)),t()})},submitBuyGoods:function(){var t=this;this.btn.on("touchend",function(){t.dataArr.goods.length>0&&(t.load.show().find("i").show(),t.load.find("span").text("订单生成中..."),$.ajax({type:"post",url:t.url,data:t.dataArr,dataType:"json",success:function(s){200==s.status?(location.href=s.link,t.load.hide()):(t.load.find("i").hide(),t.load.find("span").text(s.msg),setTimeout(function(){t.load.hide()},2e3))}}))})},scrollFixed:function(){function t(){var t=parseInt(s.documentElement.scrollTop||s.body.scrollTop);t+5>i?(n.nav.addClass(n.on),n.con.addClass(n.on)):(n.nav.removeClass(n.on),n.con.removeClass(n.on));for(var o=0,a=n.topArr.length;a>o;o++)t>n.topArr[o]&&n.nav.find("li").eq(o).addClass(n.on).siblings().removeClass(n.on)}var i,n=this;i=parseInt(this.nav.offset().top),n.con.find(".index-class-list").each(function(){var t=$(this).offset().top;n.topArr.push(t-100)}),t(),$(s).on("scroll",function(){t()})},gotoNavLocation:function(){function t(t){$("html, body").animate({scrollTop:t},"slow",function(){})}var s=this,i=!1;this.nav.find("li").on("click",function(){var n=$(this).attr("data-pcate");s.con.find(".index-class-list").each(function(){if($(this).attr("data-pcate")==n){var s=$(this).offset().top;return t(s-80),i=!0,!1}}),i||t(0)})},loadImg:function(i){var n,o,a;for(this.scrTop=parseInt(s.documentElement.scrollTop||s.body.scrollTop),n=this.curIndex;n<this.len;n++)if(o=this.imgs[n],o&&(a=parseInt(o.getBoundingClientRect().top),a+this.scrTop<this.h+this.scrTop+100)){this.curIndex=n;try{o.getAttribute(this.imgSrc)&&(o.setAttribute("src",o.getAttribute(this.imgSrc)),o.removeAttribute(this.imgSrc))}catch(e){}n==this.len-1&&(this.last=!0,$(t).unbind("scroll",i))}this.first=!1},init:function(){var s,i=this;this.addCart(),this.gotoNavLocation(),this.loadImg(),this.submitBuyGoods(),$(t).on("scroll",function(){s=arguments.callee,i.loadImg(s)}),t.onload=function(){i.scrollFixed()}}},t.Community=n}(window,document);