<?php
namespace frontend\controllers;

use Yii;
use yii\web\Controller;

/**
 * 基础校验过滤
 */
abstract class BaseController extends Controller {
    
    const APP_DOMAIN_NAME = 'mall.troto.com.cn';

    public $userinfo = [
        'uid'=>0, 'openid'=>'', 'gender'=>'', 'mobile'=>'', 'avatar'=>''
    ];
    public $request;
    public $response;
    public $resMsg;
    public $encryptUid;

    public function init() {
        parent::init();
        $this->request = ($this->request === null) ? Yii::$app->request : $this->request;
        $this->response = ($this->response === null) ? Yii::$app->response : $this->response;
        //$this->authent = ($this->authent === null) ? new AuthenticationComponents() : $this->authent;
        $this->resMsg = ['code' => -200, 'msg' => '网络异常'];

        $sessUserInfo = $this->userinfo = Yii::$app->session['userinfo'] ?: $this->userinfo;
        //未登录
        if (!$sessUserInfo['uid']) {
            if ($this->isWeixin()) {
                //session存用户默认打开的网址
                Yii::$app->session['_init_request_uri'] = Yii::$app->request->absoluteUrl;
                $this->redirect('/wechat/oauth-get');
                Yii::$app->end(); //结束用户验证信息程序
            } else {
                $this->redirect('/site/login?url=/member');
                Yii::$app->end(); //结束用户验证信息程序
            }
        }
        //未设置手机号
        if (!$sessUserInfo['mobile'] && Yii::$app->request->pathInfo!='member/user-bind') {
            Yii::$app->session['_init_request_uri'] = Yii::$app->request->absoluteUrl;
            $this->redirect('/member/user-bind');
            Yii::$app->end(); //结束用户验证信息程序
        }

        // Yii::$app->end(); //结束用户验证信息程序
    }

    private function isWeixin() {
        return (strpos($_SERVER['HTTP_USER_AGENT'], 'MicroMessenger') !== false);
    }

}